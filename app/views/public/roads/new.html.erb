<h1>地点登録</h1>
<%= form_with model: @road do |f| %>
  <div class="post">
    <%= f.label :address, "位置情報" %>
    <%= f.text_field :address %>
    <%= f.text_field :lat, id: "lat" %>
    <%= f.text_field :lng %></br>
    <%= f.label :car_model, "車種" %>
    <%= f.text_field :car_model %>
    <%= f.label :situation, "詳細説明" %>
    <%= f.text_area :situation %>

    <%= f.submit %>
  </div>
<% end %>

<h2>Map</h2>

<div id='map'></div>

<li>lat: <span ></span></li>
<li>lng: <span id="lng"></span></li>
<textarea id = "addressOutput"></textarea>

  <style>
    #map {
      height: 700px;
      width: 800px;
    }
  </style>

  <script>
    let marker = null;
    function initMap(){
      const map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 35.6803997, lng: 139.7690174},
        zoom: 12
      });

      google.maps.event.addListener(map, 'click', event => clickListener(event, map));
    }

    function clickListener(event, map) {
      //緯度・軽度の取得、住所への変換
      const lat = event.latLng.lat();
      const lng = event.latLng.lng();
      document.getElementById('lat').textContent = event.latLng.lat();
      document.getElementById('lng').textContent = event.latLng.lng();
      const latLngInput = new google.maps.LatLng(lat, lng);
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode(
        { latLng: latLngInput },
        function(results, status) {
          let address = "";

          if (status == google.maps.GeocoderStatus.OK) {
            address = results[0].formatted_address;
          } else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
            alert("住所が見つかりませんでした。");
          } else if (status == google.maps.GeocoderStatus.ERROR) {
            alert("サーバ接続に失敗しました。");
          } else if (status == google.maps.GeocoderStatus.INVALID_REQUEST) {
            alert("リクエストが無効でした。");
          } else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
            alert("リクエストの制限回数を超えました。");
          } else if (status == google.maps.GeocoderStatus.REQUEST_DENIED) {
            alert("サービスが使えない状態でした。");
          } else if (status == google.maps.GeocoderStatus.UNKNOWN_ERROR) {
            alert("原因不明のエラーが発生しました。");
          }
          document.getElementById('addressOutput').value = address;
        }
      );

      //マーカーのリセット
      if(marker){
        console.log("marker=", marker);
        marker.setMap(null);
      }
      marker = new google.maps.Marker({
        position: {lat, lng},
        map
      });
    }

  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['SECRET_KEY'] %>&callback=initMap" async defer></script>